{"version":3,"file":"matrix.cjs.production.min.js","sources":["../src/matrix.ts"],"sourcesContent":["import { Robot, Adapter, Envelope, TextMessage, User } from \"hubot\";\nimport {\n  ClientEvent,\n  ISendEventResponse,\n  MatrixClient,\n  RoomEvent,\n  RoomMemberEvent,\n} from \"matrix-js-sdk\";\n\nimport sdk from \"matrix-js-sdk\";\nimport request from \"request\";\nimport sizeOf from \"image-size\";\nimport { makeHtmlNotice, makeNotice } from \"matrix-js-sdk/lib/content-helpers\";\nimport { Parser, HtmlRenderer } from \"commonmark\";\n\n/**\n * The Matrix-specific metadata available about a message.\n */\nexport type MatrixMessageMetadata = {\n  readonly threadId?: string;\n  readonly interpretMarkdown?: boolean;\n};\n\n/**\n * Represents a regular Hubot TextMessage with additional Matrix metadata.\n */\nexport class MatrixMessage extends TextMessage {\n  constructor(\n    user: User,\n    text: string,\n    id: string,\n    public metadata: MatrixMessageMetadata\n  ) {\n    super(user, text, id);\n  }\n}\n\nexport class Matrix extends Adapter {\n  public client: MatrixClient | undefined;\n  private user_id: string | undefined;\n  private access_token: string | undefined;\n  private device_id: string | undefined;\n\n  private commonMarkReader = new Parser();\n  private commonMarkRenderer = new HtmlRenderer({ safe: true });\n\n  constructor(private robot: Robot<Matrix>) {\n    super(robot);\n    this.robot.logger.info(\"Constructor\");\n  }\n\n  handleUnknownDevices(err: { devices: { [x: string]: any } }) {\n    return (() => {\n      let result = [];\n      for (var stranger in err.devices) {\n        var devices = err.devices[stranger];\n        result.push(\n          (() => {\n            let result1 = [];\n            for (let device in devices) {\n              this.robot.logger.info(\n                `Acknowledging ${stranger}'s device ${device}`\n              );\n              result1.push(this.client?.setDeviceKnown(stranger, device));\n            }\n            return result1;\n          })()\n        );\n      }\n      return result;\n    })();\n  }\n\n  send(envelope: Envelope, ...strings: any[]) {\n    return strings.map((str) => this.sendThreaded(envelope, undefined, str));\n  }\n\n  sendThreaded(\n    envelope: Envelope,\n    threadId: string | undefined,\n    message: string\n  ): Promise<ISendEventResponse | undefined> | undefined {\n    const interpretMarkdown =\n      \"metadata\" in (envelope.message ?? {})\n        ? (envelope.message as MatrixMessage).metadata.interpretMarkdown ?? true\n        : true;\n\n    const finalMessage = interpretMarkdown\n      ? makeHtmlNotice(\n          message,\n          this.commonMarkRenderer.render(this.commonMarkReader.parse(message))\n        )\n      : makeNotice(message);\n\n    this.robot.logger.info(`Sending to ${envelope.room}: ${message}`);\n    if (/^(f|ht)tps?:\\/\\//i.test(message)) {\n      return this.sendURL(envelope, message);\n    }\n    if (threadId !== undefined) {\n      return this.client\n        ?.sendMessage(envelope.room, threadId, finalMessage)\n        ?.catch((err) => {\n          if (err.name === \"UnknownDeviceError\") {\n            this.handleUnknownDevices(err);\n            return this.client?.sendMessage(\n              envelope.room,\n              threadId,\n              finalMessage\n            );\n          }\n        });\n    }\n    return this.client\n      ?.sendMessage(envelope.room, finalMessage)\n      .catch((err) => {\n        if (err.name === \"UnknownDeviceError\") {\n          this.handleUnknownDevices(err);\n          return this.client?.sendMessage(envelope.room, finalMessage);\n        }\n      });\n  }\n\n  emote(envelope: Envelope, ...strings: string[]) {\n    return Array.from(strings).map((str) =>\n      this.client?.sendEmoteMessage(envelope.room, str).catch((err) => {\n        if (err.name === \"UnknownDeviceError\") {\n          this.handleUnknownDevices(err);\n          return this.client?.sendEmoteMessage(envelope.room, str);\n        }\n      })\n    );\n  }\n\n  reply(envelope: Envelope, ...strings: string[]) {\n    const threadId =\n      \"metadata\" in envelope.message\n        ? (envelope.message as MatrixMessage).metadata.threadId\n        : undefined;\n\n    return Array.from(strings).map((str) =>\n      this.sendThreaded(envelope, threadId, `${envelope.user.name}: ${str}`)\n    );\n  }\n\n  topic(envelope: Envelope, ...strings: string[]) {\n    return Array.from(strings).map((str) =>\n      this.client?.sendStateEvent(\n        envelope.room,\n        \"m.room.topic\",\n        {\n          topic: str,\n        },\n        \"\"\n      )\n    );\n  }\n\n  async sendURL(\n    envelope: Envelope,\n    url: string\n  ): Promise<ISendEventResponse | undefined> {\n    this.robot.logger.info(`Downloading ${url}`);\n    return new Promise((resolve, reject) => {\n      request({ url, encoding: null }, (error, response, body) => {\n        if (error) {\n          this.robot.logger.info(`Request error: ${JSON.stringify(error)}`);\n          reject(error);\n        } else if (response.statusCode === 200) {\n          let info: sdk.IImageInfo;\n          try {\n            let dims = sizeOf(body);\n            this.robot.logger.info(\n              `Image has dimensions ${JSON.stringify(dims)}, size ${\n                body.length\n              }`\n            );\n            if (dims.type === \"jpg\") {\n              dims.type = \"jpeg\";\n            }\n            info = {\n              mimetype: `image/${dims.type}`,\n              h: dims.height,\n              w: dims.width,\n              size: body.length,\n            };\n            resolve(\n              this.client\n                ?.uploadContent(body, {\n                  name: url,\n                  type: info.mimetype,\n                  rawResponse: false,\n                  onlyContentUri: true,\n                })\n                .then((content_uri) => {\n                  return this.client\n                    ?.sendImageMessage(envelope.room, content_uri, info, url)\n                    .catch((err) => {\n                      if (err.name === \"UnknownDeviceError\") {\n                        this.handleUnknownDevices(err);\n                        return this.client?.sendImageMessage(\n                          envelope.room,\n                          content_uri,\n                          info,\n                          url\n                        );\n                      }\n                    });\n                })\n            );\n          } catch (error1) {\n            error = error1;\n            this.robot.logger.info(error.message);\n            resolve(this.sendThreaded(envelope, undefined, ` ${url}`));\n          }\n        }\n      });\n    });\n  }\n\n  run() {\n    this.robot.logger.info(`Run ${this.robot.name}`);\n    let client = sdk.createClient({\n      baseUrl: process.env.HUBOT_MATRIX_HOST_SERVER || \"https://matrix.org\",\n      request: request,\n    });\n    return client.login(\n      \"m.login.password\",\n      {\n        user: process.env.HUBOT_MATRIX_USER || this.robot.name,\n        password: process.env.HUBOT_MATRIX_PASSWORD,\n      },\n      (\n        err: any,\n        data: { user_id: string; access_token: string; device_id: string }\n      ) => {\n        if (err) {\n          this.robot.logger.error(err);\n          return;\n        }\n        this.user_id = data.user_id;\n        this.access_token = data.access_token;\n        this.device_id = data.device_id;\n        this.robot.logger.info(\n          `Logged in ${this.user_id} on device ${this.device_id}`\n        );\n        this.client = sdk.createClient({\n          baseUrl: process.env.HUBOT_MATRIX_HOST_SERVER || \"https://matrix.org\",\n          accessToken: this.access_token,\n          userId: this.user_id,\n          deviceId: this.device_id,\n          request,\n        });\n        this.client?.on(ClientEvent.Sync, (state) => {\n          switch (state) {\n            case \"PREPARED\":\n              this.robot.logger.info(\n                `Synced ${this.client?.getRooms().length} rooms`\n              );\n              // We really don't want to let people set the display name to something other than the bot\n              // name because the bot only reacts to it's own name.\n              const currentDisplayName = this.client?.getUser(\n                this.user_id ?? \"\"\n              )?.displayName;\n              if (this.robot.name !== currentDisplayName) {\n                this.robot.logger.info(\n                  `Setting display name to ${this.robot.name}`\n                );\n                this.client?.setDisplayName(this.robot.name, () => {});\n              }\n              return this.emit(\"connected\");\n          }\n        });\n        this.client?.on(\n          RoomEvent.Timeline,\n          (event, room, toStartOfTimeline) => {\n            if (\n              event.getType() === \"m.room.message\" &&\n              toStartOfTimeline === false\n            ) {\n              this.client?.setPresence({ presence: \"online\" });\n              let id = event.getId();\n              let message = event.getContent();\n              let name = event.getSender();\n              let user = this.robot.brain.userForId(name);\n              user.room = room.roomId;\n              if (name !== this.user_id) {\n                this.robot.logger.info(\n                  `Received message: ${JSON.stringify(message)} in room: ${\n                    user.room\n                  }, from: ${user.name} (${user.id}).`\n                );\n                if (message.msgtype === \"m.text\") {\n                  const messageThreadId = event.threadRootId ?? id;\n\n                  this.receive(\n                    new MatrixMessage(user, message.body, id, {\n                      threadId: messageThreadId,\n                    })\n                  );\n                }\n                if (\n                  message.msgtype !== \"m.text\" ||\n                  message.body.indexOf(this.robot.name) !== -1\n                ) {\n                  return this.client?.sendReadReceipt(event);\n                }\n              }\n            }\n          }\n        );\n        this.client?.on(RoomMemberEvent.Membership, async (event, member) => {\n          if (\n            member.membership === \"invite\" &&\n            member.userId === this.user_id\n          ) {\n            await this.client?.joinRoom(member.roomId);\n            this.robot.logger.info(`Auto-joined ${member.roomId}`);\n          }\n        });\n        return this.client?.startClient({ initialSyncLimit: 0 });\n      }\n    );\n  }\n}\n\nexport function use(robot: Robot<any>): Matrix {\n  return new Matrix(robot);\n}\n"],"names":["MatrixMessage","_TextMessage","user","text","id","metadata","_this","call","this","_inheritsLoose","TextMessage","Matrix","_Adapter","robot","_this2","client","user_id","access_token","device_id","commonMarkReader","Parser","commonMarkRenderer","HtmlRenderer","safe","logger","info","_proto","prototype","handleUnknownDevices","err","_this3","result","stranger","devices","push","result1","device","_this3$client","setDeviceKnown","send","envelope","_this4","_len","arguments","length","strings","Array","_key","map","str","sendThreaded","undefined","threadId","message","_envelope$message","_envelope$message$met","_this$client2","_this$client","_this$client$sendMess","_this5","finalMessage","interpretMarkdown","makeHtmlNotice","render","parse","makeNotice","room","test","sendURL","sendMessage","_this5$client","name","_this5$client2","emote","_this6","_len2","_key2","from","_this6$client","sendEmoteMessage","_this6$client2","reply","_this7","_len3","_key3","topic","_this8","_len4","_key4","_this8$client","sendStateEvent","_sendURL","_asyncToGenerator","_regeneratorRuntime","mark","_callee","url","_this9","wrap","_context","prev","next","abrupt","Promise","resolve","reject","request","encoding","error","response","body","JSON","stringify","statusCode","_this9$client","dims","sizeOf","type","mimetype","h","height","w","width","size","uploadContent","rawResponse","onlyContentUri","then","content_uri","_this9$client2","sendImageMessage","_this9$client3","error1","stop","_x","_x2","apply","run","_this10","sdk","createClient","baseUrl","process","env","HUBOT_MATRIX_HOST_SERVER","login","HUBOT_MATRIX_USER","password","HUBOT_MATRIX_PASSWORD","data","_this10$client","_this10$client5","_this10$client8","_this10$client10","accessToken","userId","deviceId","on","ClientEvent","Sync","state","_this10$client2","_this10$client3","_this10$client3$getUs","_this10$user_id","getRooms","_this10$client4","currentDisplayName","getUser","displayName","setDisplayName","emit","RoomEvent","Timeline","event","toStartOfTimeline","getType","_this10$client6","setPresence","presence","getId","getContent","getSender","brain","userForId","roomId","msgtype","_event$threadRootId","messageThreadId","threadRootId","receive","_this10$client7","indexOf","sendReadReceipt","RoomMemberEvent","Membership","_ref","_callee2","member","_this10$client9","_context2","membership","joinRoom","_x3","_x4","startClient","initialSyncLimit","Adapter"],"mappings":"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"}